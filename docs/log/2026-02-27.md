# 工作日志 - 2026-02-27

## 今日完成

1. **promptbuild 审计能力落地**
   - 新增按天 JSONL 审计日志写入。
   - 新增日志保留清理（默认 7 天）。
   - 审计失败仅告警，不影响主流程返回。

2. **promptbuild 配置化组装骨架落地**
   - 新增 `PromptAssemblySpec` / `SectionSpec` 结构。
   - 支持通过 `agent/spec_path` 加载 YAML 组装配置。
   - 支持按 `order` 排序、`required` 必填校验、多种 `source_type` 映射。
   - 保持旧路径兼容：未指定 spec 时继续走固定 section 顺序。

3. **主 Agent 接入（默认回退模式）**
   - 在 `internal/agent/agent.go` 接入 promptbuild 调用入口。
   - 增加开关 `COCO_AGENT_PROMPTBUILD_ENABLE=true` 才启用。
   - 默认关闭；即使启用后失败也自动回退旧 prompt 流程。

4. **文档与样例补充**
   - 更新 `docs/promptbuild.md`。
   - 更新 `internal/promptbuild/README.md`。
   - 新增 `docs/promptbuild-agent-spec.example.yaml`。

5. **测试与验证**
   - 新增审计、spec、builder 相关测试：
     - `internal/promptbuild/audit_test.go`
     - `internal/promptbuild/spec_test.go`
     - `internal/promptbuild/builder_test.go`
   - 执行通过：
     - `go test ./internal/agent ./internal/promptbuild ./internal/config`

## 今日提交

- Commit: `e92daf9`
- Message: `feat: add auditable promptbuild assembly and agent fallback integration`

## 备注

- 本次按计划未接入 `internal/agent/agent.go` 以外的主链路重构，仅做可开关的最小接入。
- 当前主行为默认不变（回退模式）。

---

## 追加工作（联调与发布收尾）

### 1. Keeper 线上升级与服务化

- 目标服务器：`47.100.66.40`（`deploy` 用户，目录 `~/projects/coco`）
- 本地交叉编译 Linux 二进制并上传替换 keeper
- 将 keeper 从 `nohup` 方式切换为 `systemd --user` 托管：
  - 单元：`~/.config/systemd/user/coco-keeper.service`
  - 启动命令：`/home/deploy/projects/coco/coco keeper --port 8080 --log info`
- 验证通过：`is-enabled=enabled`、`is-active=active`、`/health` 正常

### 2. 本地 relay 常驻化（Windows）

- 当前代码原生 service manager 不支持 Windows
- 新增守护脚本：`scripts/relay-service.ps1`
  - 持续拉起 `coco relay`
  - 异常退出后延迟重启（默认 5 秒）
  - 输出写入 `relay-service.log`
- 配置用户登录自启：`HKCU\Software\Microsoft\Windows\CurrentVersion\Run` -> `CocoRelayService`
- 实测 relay 持续在线，keeper 端显示 `coco=online`

### 3. 企业微信联调结果

- 企业微信多轮对话成功
- `ai.get_current_model`、`ai.switch_model` 实测可用
- 早期失败原因定位为沙箱网络限制，切换非沙箱后恢复

### 4. Phase1 文档更新

- 更新：
  - `docs/phase1-final-plan.md`
  - `docs/phase1-acceptance-plan.md`
  - `docs/phase1-acceptance-runbook.md`
- 补充今日联调、部署与服务化落地情况

### 5. 发布与标签

- 版本号更新：`Makefile` -> `VERSION := 1.10.0`
- 发布提交：`cc0c78d`
  - `feat: phase1 rollout, service runtime updates, and release docs`
- 安全修复提交：`83615c8`
  - `security: ignore local provider configs and runtime secret files`
- 标签：
  - `v1.10.0` -> `cc0c78d`
  - `v1.10.1` -> `83615c8`
- 已推送：
  - `master`
  - `v1.10.0`
  - `v1.10.1`

---

## 追加工作（Phase3 记忆与编排联调）

### 1. 长程记忆（Markdown + Obsidian）最小切片落地

- 新增 `memory` 配置段（`memory.enabled`、`memory.obsidian_vault`、`memory.core_files` 等）。
- 新增 Markdown 记忆引擎：扫描核心记忆文件 + Obsidian `.md`，基于文件修改时间自动刷新缓存，避免过时数据。
- 新增工具：
  - `memory_search`：检索本地 markdown 记忆
  - `memory_get`：读取单个记忆文件内容（路径范围受限）
- 新增核心记忆文件骨架：
  - `memory/MEMORY.md`
  - `memory/user_profile.md`
  - `memory/response_style.md`
  - `memory/project_context.md`

### 2. PromptBuild 主链路增强

- Agent 的 PromptBuild 请求固定使用 `agent: coco`，默认加载 `prompts/specs/coco.yaml`。
- 将记忆召回内容注入 PromptBuild 输入字段：`memory_recall`。
- 在 spec 与 builder 中新增预算控制能力：
  - `defaults.max_prompt_chars`
  - `sections[].max_chars`
- 超预算时按策略裁剪，优先非必填 section，避免上下文溢出。

### 3. `memory_search` 升级为 Hybrid 检索

- 检索链路升级为：
  - 关键词召回（lexical）
  - 时间衰减打分（temporal decay）
  - 向量语义相似度（embedding）
  - MMR 重排（去冗余、保多样性）
- 失败降级：向量不可用或调用异常时自动退回 lexical + temporal，不阻断主流程。

### 4. 两阶段编排（Phase3 第三步）落地

- 新增两阶段编排主链路（默认开启，可通过 `COCO_AGENT_ORCHESTRATION_ENABLE` 控制）：
  1. 快模型 planner 生成结构化计划（是否追问、检索词、最终回答指令、复杂度）。
  2. 必要时先追问；否则追加 planner recall 后切换高智力模型输出最终答案。
- 新增 `planner_instruction` 输入并接入 `prompts/specs/coco.yaml`。

### 5. 测试与验证

- 新增/更新测试覆盖：
  - markdown 记忆新鲜度与访问边界
  - temporal decay / MMR 行为
  - PromptBuild budget 裁剪
  - orchestration 纯函数（JSON 提取、query 归一化、复杂度归一化）
- 执行通过：
  - `go test ./internal/agent ./internal/promptbuild ./internal/config`
  - `go test ./...`

### 6. Keeper/Relay 验收环境联调

- 本地交叉编译 Linux 二进制并上传：
  - `dist/coco-linux-amd64` -> `/home/deploy/projects/coco/coco.new`
  - 本地 SHA256：`d2fc57853f6e6fbccb45f70436cb66b2c541d3cace0279a9ec25504b03644304`
- 远端替换并重启 keeper（`deploy@47.100.66.40`）：
  - `coco-keeper.service` 状态：`active`
  - 健康检查：`{"status":"ok","coco":"online"}`
- 本地 relay 成功连接远端 keeper（日志含 `Authenticated` / `Connected`）。

### 7. 下次启动建议

- 从本日志“追加工作（Phase3 记忆与编排联调）”继续。
- 优先事项：
  1. 以真实用户问题做一轮端到端验收（含“需要追问”与“不需要追问”两类）。
  2. 根据验收结果调优 `prompts/specs/coco.yaml` 的 section 预算与顺序。
