# 工作日志 - 2026-02-27

## 今日完成

1. **promptbuild 审计能力落地**
   - 新增按天 JSONL 审计日志写入。
   - 新增日志保留清理（默认 7 天）。
   - 审计失败仅告警，不影响主流程返回。

2. **promptbuild 配置化组装骨架落地**
   - 新增 `PromptAssemblySpec` / `SectionSpec` 结构。
   - 支持通过 `agent/spec_path` 加载 YAML 组装配置。
   - 支持按 `order` 排序、`required` 必填校验、多种 `source_type` 映射。
   - 保持旧路径兼容：未指定 spec 时继续走固定 section 顺序。

3. **主 Agent 接入（默认回退模式）**
   - 在 `internal/agent/agent.go` 接入 promptbuild 调用入口。
   - 增加开关 `COCO_AGENT_PROMPTBUILD_ENABLE=true` 才启用。
   - 默认关闭；即使启用后失败也自动回退旧 prompt 流程。

4. **文档与样例补充**
   - 更新 `docs/promptbuild.md`。
   - 更新 `internal/promptbuild/README.md`。
   - 新增 `docs/promptbuild-agent-spec.example.yaml`。

5. **测试与验证**
   - 新增审计、spec、builder 相关测试：
     - `internal/promptbuild/audit_test.go`
     - `internal/promptbuild/spec_test.go`
     - `internal/promptbuild/builder_test.go`
   - 执行通过：
     - `go test ./internal/agent ./internal/promptbuild ./internal/config`

## 今日提交

- Commit: `e92daf9`
- Message: `feat: add auditable promptbuild assembly and agent fallback integration`

## 备注

- 本次按计划未接入 `internal/agent/agent.go` 以外的主链路重构，仅做可开关的最小接入。
- 当前主行为默认不变（回退模式）。

---

## 追加工作（联调与发布收尾）

### 1. Keeper 线上升级与服务化

- 目标服务器：`47.100.66.40`（`deploy` 用户，目录 `~/projects/coco`）
- 本地交叉编译 Linux 二进制并上传替换 keeper
- 将 keeper 从 `nohup` 方式切换为 `systemd --user` 托管：
  - 单元：`~/.config/systemd/user/coco-keeper.service`
  - 启动命令：`/home/deploy/projects/coco/coco keeper --port 8080 --log info`
- 验证通过：`is-enabled=enabled`、`is-active=active`、`/health` 正常

### 2. 本地 relay 常驻化（Windows）

- 当前代码原生 service manager 不支持 Windows
- 新增守护脚本：`scripts/relay-service.ps1`
  - 持续拉起 `coco relay`
  - 异常退出后延迟重启（默认 5 秒）
  - 输出写入 `relay-service.log`
- 配置用户登录自启：`HKCU\Software\Microsoft\Windows\CurrentVersion\Run` -> `CocoRelayService`
- 实测 relay 持续在线，keeper 端显示 `coco=online`

### 3. 企业微信联调结果

- 企业微信多轮对话成功
- `ai.get_current_model`、`ai.switch_model` 实测可用
- 早期失败原因定位为沙箱网络限制，切换非沙箱后恢复

### 4. Phase1 文档更新

- 更新：
  - `docs/phase1-final-plan.md`
  - `docs/phase1-acceptance-plan.md`
  - `docs/phase1-acceptance-runbook.md`
- 补充今日联调、部署与服务化落地情况

### 5. 发布与标签

- 版本号更新：`Makefile` -> `VERSION := 1.10.0`
- 发布提交：`cc0c78d`
  - `feat: phase1 rollout, service runtime updates, and release docs`
- 安全修复提交：`83615c8`
  - `security: ignore local provider configs and runtime secret files`
- 标签：
  - `v1.10.0` -> `cc0c78d`
  - `v1.10.1` -> `83615c8`
- 已推送：
  - `master`
  - `v1.10.0`
  - `v1.10.1`
